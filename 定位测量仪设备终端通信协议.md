 `设备终端通信协议` 是指定位测量设备与手持终端之间的点对点文本传输协议。一般情况下，需要支持蓝牙、串口等两种主要的通信方式。

| 文档编号      | 版本     | 日期         |
| --------- | ------ | ---------- |
| SDZB-0001 | V1.0.0 | 2025-10-13 |

#### 通用格式标准
- **起始符**：`$`
- **消息类型码**：3~8 字母（例如 `$CMD`、`$PWR`、`$GNGGA` 等）
- **字段分隔**：`,`（逗号）
- **校验分隔符**：`*` 后跟两位十六进制校验（大写），例如 `*4A`校验算法为 XOR（对 `$` 与 `*` 之间的所有字节按位异或）
- **结束符**：`\r\n`
- **消息时间戳**：UTC 时间格式 `hhmmss.ss`（例如 `123456.78`）
- **编码**：UTF-8（实际字段均为 ASCII 字符）
- **字符串长度**：单条消息不超过 2048 字节（考虑串口缓冲和稳定性）
- **时间同步**：多个设备数据融合时，以卫星定位时间为基准

#### 通信类型及用途
- **蓝牙通信**：软件接口的标准通信方式，支持点对点文本传输
- **串口通信**：用于设备的初始设置、输入/输出调试
- **WiFi**：传输 RTMP/RTSP 视频流（不涉及文本协议）

### 指令协议

#### 通用指令格式
- **功能**：定义所有指令的请求和应答格式请求用于发送命令，应答用于确认或报告错误
- **请求字段**：
  - `$CMD`：消息类型码（请求）
  - `subcommand`：子命令（如 `DEV.CONFIG`、`DEV.CTRL`）
  - `param1 ... paramN`：参数列表（根据子命令格式而定，用空格分开）
  - `*HH`：校验码（两位十六进制大写）
- **应答字段**
  - `$ACK`：消息类型码（应答）
  - subcommand：请求子命令
  - `param1 ... paramN`：请求的参数列表
  - `:OK RESPONSE`：正常应答内容（根据子命令响应格式而定）
  -  `:ERROR MESSAGE` ：错误应答（‘`:`’之后没有 ‘`OK`’ 短语）
  - `*HH`：校验码（两位十六进制大写）
- **示例**
  请求：`$CMD,DEV.CONFIG POWER 1s*4A\r\n`  
  应答正常：`$ACK,DEV.CONFIG POWER 1s,:OK*5B\r\n`  
  应答错误：`$ACK,DEV.CONFIG POWER 1s,:PARSING FAILED*6C\r\n`

#### 设备电源信息输出配置
- **功能**：配置设备电源信息的输出频率（例如，每 1 秒输出一次电量消息）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG POWER`：子命令
  - `频率`：输出频率（如 `1s` 表示 1Hz）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG POWER 1s*4A\r\n`

#### GNSS 配置串口
- **功能**：配置设备端 GNSS 模块的串口参数（如波特率）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG GNSS`：子命令
  - `COM端口`：串口号（如 `COM1`）
  - `波特率`：波特率值（如 `115200`）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG GNSS COM1 115200*7D\r\n`

#### GNSS 标准报文输出频率配置
- **功能**：配置特定 GNSS NMEA 报文的输出频率`GN---` 表示多星模式（GPS+北斗等），单北斗模式可使用 `BD---`
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG GNSS.报文类型`：
    `GNSS.GNGGA`、`GNSS.GNGSV`、`GNSS.GNGSA`、`GNSS.GNRMC`、`GNSS.GNHDT`
  - `频率`：输出频率（如 `1hz` 或 1s）
  - `*HH`：校验码
- **完整示例**
  GNGGA：`$CMD,DEV.CONFIG GNSS.GNGGA 1hz*8E\r\n`  
  GNGSV：`$CMD,DEV.CONFIG GNSS.GNGSV 1hz*9F\r\n`  
  GNGSA：`$CMD,DEV.CONFIG GNSS.GNGSA 1hz*AF\r\n`  
  GNRMC：`$CMD,DEV.CONFIG GNSS.GNRMC 1hz*BC\r\n`  
  GNHDT：`$CMD,DEV.CONFIG GNSS.GNHDT 1hz*CD\r\n`

#### GNSS HPD 扩展报文输出频率配置
- **功能**：配置 GNSS+IMU 融合的扩展 NMEA 报文（HPD）输出频率，用于单天线 GNSS 姿态数据
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG GNSS.GNHPD`：子命令
  - `频率`：输出频率（如 `1hz`）
  - `*HH`：校验码
- **完整示例**：`$CMD,DEV.CONFIG GNSS.GNHPD 1hz*DE\r\n`

#### GNSS 启动/关闭
- **功能**：启动或关闭 GNSS 模块（ID 可选，用于多设备区分）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CTRL GNSS.OPEN/CLOSE`：子命令
  - `ID`：设备 ID（可选）
  - `*HH`：校验码
- **示例**
  启动：`$CMD,DEV.CTRL GNSS.OPEN ID*EF\r\n`  
  应答：`$ACK,DEV.CTRL GNSS.OPEN ID,:OK*F0\r\n`  
  关闭：`$CMD,DEV.CTRL GNSS.CLOSE ID*01\r\n`

#### IMU 输出频率配置
- **功能**：配置设备端 IMU 模块的原始输出频率
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG IMU`：子命令
  - `频率`：输出频率（如 `200hz`）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG IMU 200hz*12\r\n`

### IMU 通信传输频率配置
- **功能**：配置 IMU 日志数据的传输频率（姿态计算结果）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG IMU.LOG`：子命令
  - `频率`：传输频率（如 `1hz`）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG IMU.LOG 1hz*23\r\n`

#### IMU 启动/关闭
- **功能**：启动或关闭 IMU 模块（ID 可选，用于多设备区分）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CTRL IMU.OPEN/CLOSE`：子命令
  - `ID`：设备 ID（可选）
  - `*HH`：校验码
- **示例**
  启动：`$CMD,DEV.CTRL IMU.OPEN ID*34\r\n`  
  关闭：`$CMD,DEV.CTRL IMU.CLOSE ID*45\r\n`

#### 激光测距输出频率配置
- **功能**：配置激光测距数据的输出频率
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG LASER.LRG`：子命令
  - `频率`：输出频率（如 `1hz`）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG LASER.LRG 1hz*56\r\n`

#### 激光定位输出频率配置
- **功能**：配置激光定位结果的输出频率
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG LASER.LPO`：子命令
  - `频率`：输出频率（如 `1hz`）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG LASER.LPO 1hz*67\r\n`

#### 激光启动/关闭
- **功能**：启动或关闭激光模块（ID 用于设备区分，ON 表示启用模式）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CTRL LASER.OPEN/CLOSE`：子命令
  - `ID`：设备 ID
  - `ON`：启用标志（可选）
  - `*HH`：校验码
- **示例**
  启动：`$CMD,DEV.CTRL LASER.OPEN ID ON*78\r\n`  
  关闭：`$CMD,DEV.CTRL LASER.CLOSE ID ON*89\r\n`

#### 相机网络配置
- **功能**：配置或查询相机 WiFi 网络凭证（AUTH_BASE64 为 base64 编码的 `ssid:pwd`）省略参数则查询设备联网信息
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CONFIG CAMERA.NETWORK`：子命令
  - `AUTH_BASE64`：base64 编码凭证（可选）
  - `*HH`：校验码
- **应答字段**：（`:OK` 之后的响应内容）
  - `LAN_IP`:  局域网 IP xxx.xxx.xxx.xxx
  -  `LAN_GATEWAY`: 局域网网关 xxx.xxx.xxx.xxx
  - `MAC_ADDR`：网卡地址 AA:BB:CC:DD:EE:FF
- **示例**
  配置：`$CMD,DEV.CONFIG CAMERA.NETWORK AUTH_BASE64*9A\r\n`  
  应答：`$ACK,DEV.CONFIG CAMERA.NETWORK AUTH_BASE64,:OK LAN_IP=192.168.1.100;LAN_GATEWAY=192.168.1.1;MAC_ADDR=AA:BB:CC:DD:EE:FF*BC\r\n`

#### 相机启动
- **功能**：启动指定相机（ID 区分双摄），返回视频流格式和 URL
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CTRL CAMERA.OPEN`：子命令
  - `ID`：相机 ID（必填）
  - `*HH`：校验码
- **应答字段**`：`（`:OK` 之后的响应内容）
  - `LAB`：名称
  - `W`：宽度
  - `H`：高度
  - `FPS`：帧率
  - `ENC`：编码(MJPEG/H264/RAW)
  - `URL`：流地址
- **示例**：
  启动：`$CMD,DEV.CTRL CAMERA.OPEN 1*CD\r\n`  
  应答：`$ACK,DEV.CTRL CAMERA.OPEN 1,:OK LAB=FrontCam;W=1920;H=1080;FPS=30;ENC=H264;URL=rtmp://192.168.1.2:8554/live1*DE\r\n`

#### 相机关闭
- **功能**：关闭指定相机（ID 区分双摄）
- **字段**：
  - `$CMD`：消息类型码
  - `DEV.CTRL CAMERA.CLOSE`：子命令
  - `ID`：相机 ID（必填）
  - `*HH`：校验码
- **示例**：`$CMD,DEV.CONFIG CAMERA.CLOSE 1*EF\r\n`

### 数据消息协议

#### 设备电量消息
- **功能**：报告设备电源状态，包括电压、SOC 和充电状态
- **字段**：
  - `$PWR`：消息类型码
  - `UTIME`：UTC 时间戳 `hhmmss.ss`
  - `SOURCE`：电源源（`BAT1`/`BAT2` 主/备用电池，`MAIN` 外部供电）
  - `VOLT_CURR`：当前电压（V）
  - `VOLT_MIN`：电压下限报警（V）
  - `VOLT_MAX`：最大电压（V）
  - `SOC`：剩余百分比（0-100）
  - `CHG_STAT`：充电状态（`C`=充电，`D`=放电，`I`=静止）
  - `TEMP`：电池温度（°C）
  - `*HH`：校验码
- **示例**：`$PWR,123456.78,BAT1,12.5,11.0,14.0,85,C,25*3F\r\n`

#### GGA 消息
- **功能**：提供 GPS 接收机的 UTC 时间、位置和固定相关数据，包括纬度、经度、高度、卫星数量、精度因子等，用于基本定位信息输出。
- **字段**：
  - `UTIME`：协议添加的 UTC 时间戳 `hhmmss.ss`。
  - 标准 NMEA 字段（位置从 1 开始）：
    1. UTC 时间 `hhmmss.ss`（小时、分钟、秒）。
    2. 纬度 `ddmm.mm`（度分格式）。
    3. 纬度方向 `N` 或 `S`。
    4. 经度 `ddmm.mm`（度分格式）。
    5. 经度方向 `E` 或 `W`。
    6. GPS 质量指示（0=无固定，1=GPS 固定，2=差分 GPS 等）。
    7. 使用卫星数（00-12）。
    8. 水平精度因子（HDOP，米）。
    9. 天线高度（米，相对于平均海平面）。
    10. 高度单位 `M`（米）。
    11. 地壳分离（米，WGS-84 椭球与平均海平面差）。
    12. 地壳分离单位 `M`（米）。
    13. 差分 GPS 数据年龄（秒，可空）。
    14. 差分参考站 ID（0000-1023，可空）。
    - `*HH`：校验码（XOR，两位十六进制大写）。
- **示例**：`$GNGGA,123456.78,001043.00,4404.14036,N,12118.85961,W,1,12,0.98,1113.0,M,-21.3,M,,*47\r\n`

#### GSV 消息
- **功能**：描述视野内 GPS 卫星的天空位置，包括仰角、方位角和信噪比（SNR），通常以 2-3 条消息组形式发送，用于卫星跟踪信息。
- **字段**：
  - `UTIME`：协议添加的 UTC 时间戳 `hhmmss.ss`。
  - 标准 NMEA 字段（位置从 1 开始）：
    1. 组内 GSV 消息总数（1-9）。
    2. 当前 GSV 消息序号（1-9）。
    3. 视野内卫星总数（带前导零）。
    4. 卫星 PRN/ID（带前导零）。
    5. 仰角（度，-90 到 90，带前导零）。
    6. 方位角（度，真北 000-359，带前导零）。
    7. SNR（dB，00-99，带前导零）。
    - 后续字段：更多卫星信息四元组（重复 4-7）。
    - 最后：信号 ID（NMEA 4.11，可选）和 `*HH`：校验码。
- **示例**：`$GNGSV,123456.78,3,1,11,03,03,111,00,04,15,270,00,06,01,010,00,13,06,292,00*74\r\n`

#### GSA 消息
- **功能**：提供 GPS DOP（精度因子）和活跃卫星信息，包括固定模式、使用的卫星 ID、PDOP/HDOP/VDOP 等，用于评估定位精度。
- **字段**：
  - `UTIME`：协议添加的 UTC 时间戳 `hhmmss.ss`。
  - 标准 NMEA 字段（位置从 1 开始）：
    1. 选择模式 `M`=手动，`A`=自动。
    2. 固定模式（1=无固定，2=2D，3=3D）。
    3-14. 用于固定的卫星 ID（最多 12 个，可空）。
    3. PDOP（位置精度因子）。
    4. HDOP（水平精度因子）。
    5. VDOP（垂直精度因子）。
    - 最后：系统 ID（NMEA 4.11，可选）和 `*HH`：校验码。
- **示例**：`$GNGSA,123456.78,A,3,80,71,73,79,69,,,,,,,,1.83,1.09,1.47*17\r\n`

#### RMC 消息
- **功能**：提供推荐的最小 GPS/Transit 数据，包括时间、日期、位置、速度、航向和磁变角，用于基本导航信息。
- **字段**：
  - `UTIME`：协议添加的 UTC 时间戳 `hhmmss.ss`。
  - 标准 NMEA 字段（位置从 1 开始）：
    1. UTC 固定时间 `hhmmss.ss`。
    2. 状态 `A`=有效，`V`=警告。
    3. 纬度 `ddmm.mm`。
    4. 纬度方向 `N` 或 `S`。
    5. 经度 `dddmm.mm`。
    6. 经度方向 `E` 或 `W`。
    7. 地面速度（节）。
    8. 真实航向（度）。
    9. 日期 `ddmmyy`。
    10. 磁变角（度）。
    11. 磁变角方向 `E` 或 `W`。
    12. FAA 模式指示（NMEA 2.3+，如 `A`）。
    13. 导航状态（NMEA 4.1+，如 `A`=自主）。
    - `*HH`：校验码。
- **示例**：`$GNRMC,123456.78,001031.00,A,4404.13993,N,12118.86023,W,0.146,,100117,,,A*7B\r\n`

#### HPD 位置与姿态消息
- **功能**：报告 GNSS+IMU 融合的位置、姿态和基线数据（扩展 NMEA 报文）
- **字段**：
  - `$GNHPD`：消息类型码
  - `GPS_WEEK`：GPS 周数（从 1980-1-6 起，xxxx）
  - `GPS_SEC`：当日秒数（xxxx.xx）
  - `HEADING`：航向（度）
  - `PITCH`：俯仰（度）
  - `ROLL`：横滚（度）
  - `LAT`：纬度（度）
  - `LON`：经度（度）
  - `ALT`：高程（m）
  - `DX/DY/DZ`：基线东/北/天向距离（m）
  - `VX/VY/VZ`：东/北/天向速度（m/s）
  - `VDX/VDY/VDZ`：速度差（m/s）
  - `BASE`：基线长度（m）
  - `STAT`：状态（0:无效；1:单点；2:伪距差分；4:RTK固定；5:RTK浮点）
  - `*HH`：校验码
- **示例**：`$GNHPD,1980,12345.67,90.5,5.2,-2.1,39.123456,116.654321,50.0,1.2,3.4,0.5,0.1,0.2,0.0,0.05,0.03,0.02,2.5,4*5A\r\n`

#### IMU 数据消息
- **功能**：输出 IMU 姿态计算结果（仅姿态，不含原始数据）
- **字段**：
  - `$IMU`：消息类型码
  - `UTIME`：UTC 时间戳 `hhmmss.ss`
  - `ROLL`：横滚（度）
  - `PITCH`：俯仰（度）
  - `YAW`：偏航（度）
  - `STAT`：状态（有效性标志）
  - `*HH`：校验码
- **示例**：`$IMU,123456.78,-1.5,2.0,89.8,1*6B\r\n`

#### 激光测距消息
- **功能**：报告激光测距结果，包括距离和有效性
- **字段**：
  - `$LRG`：消息类型码
  - `UTIME`：UTC 时间戳 `hhmmss.ss`
  - `DIST`：距离值
  - `UNIT`：单位（`M` 表示米）
  - `STRENGTH`：回波强度（可选）
  - `STAT`：有效性（0:无效，1:有效）
  - `*HH`：校验码
- **示例**：`$LRG,123456.78,10.5,M,85,1*7C\r\n`

#### 激光定位消息
- **功能**：报告激光定位结果，包括位置、姿态和质量
- **字段**：
  - `$LPO`：消息类型码
  - `UTIME`：UTC 时间戳 `hhmmss.ss`
  - `POS_X/POS_Y/POS_Z`：位置坐标（m）
  - `ROLL`：横滚（度）
  - `PITCH`：俯仰（度）
  - `YAW`：偏航（度）
  - `QUAL`：评价值（质量指标）
  - `*HH`：校验码
- **示例**：`$LPO,123456.78,1.2,3.4,0.5,-0.1,1.0,90.0,0.95*8D\r\n`